<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diwali Greeting Generator - Create & Share</title>
  <meta name="description" content="Create personalized Diwali greeting cards with animations and share with family & friends" />
  <meta property="og:title" content="Diwali Greeting Generator" />
  <meta property="og:description" content="Create beautiful animated Diwali greetings and share instantly!" />
  <meta property="og:type" content="website" />
  
  <style>
    :root {
      --bg: #0b1020;
      --accent: #ffcc33;
      --accent-dark: #ff6f61;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      font-family: Inter, system-ui, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #0b1020 0%, #071025 100%);
      color: #111;
    }
    
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      color: #fff;
      margin-bottom: 30px;
      text-align: center;
    }
    
    header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ffcc33, #ff6f61);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    header p {
      font-size: 0.95rem;
      opacity: 0.8;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      flex: 1;
    }
    
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .right-panel {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .panel {
      background: rgba(255, 255, 255, 0.06);
      padding: 24px;
      border-radius: 12px;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: #fff;
      font-weight: 500;
    }
    
    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      font-family: inherit;
      font-size: 0.95rem;
      outline: none;
      transition: all 0.2s;
    }
    
    input[type="text"]::placeholder,
    textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: var(--accent);
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .template-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .template-btn {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .template-btn:hover,
    .template-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #000;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 204, 51, 0.3);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .card-preview {
      width: 100%;
      max-width: 500px;
      height: 320px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      position: relative;
      background: linear-gradient(180deg, #071025 0%, #04101a 100%);
      color: #fff;
      display: flex;
    }
    
    .card-preview canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }
    
    .card-content {
      position: relative;
      z-index: 2;
      display: flex;
      width: 100%;
      height: 100%;
    }
    
    .card-left {
      width: 35%;
      background: #0b1020;
      padding: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      border-right: 2px solid rgba(255, 204, 51, 0.2);
    }
    
    .card-right {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent);
    }
    
    .card-subtitle {
      font-size: 0.75rem;
      opacity: 0.8;
      line-height: 1.4;
    }
    
    .card-recipient {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--accent);
    }
    
    .card-message {
      font-size: 0.85rem;
      line-height: 1.5;
      margin-bottom: 8px;
      opacity: 0.95;
    }
    
    .card-culture {
      font-size: 0.72rem;
      opacity: 0.7;
      margin-bottom: 12px;
      line-height: 1.3;
    }
    
    .card-sender {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: auto;
    }
    
    .share-section {
      display: none;
      background: rgba(255, 204, 51, 0.1);
      border: 1px solid rgba(255, 204, 51, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .share-section.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .share-title {
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1rem;
    }
    
    .share-link-box {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .share-link-box input {
      flex: 1;
      background: rgba(0, 0, 0, 0.3) !important;
      border: 1px solid rgba(255, 204, 51, 0.3) !important;
    }
    
    .share-platforms {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .share-platform-btn {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
      text-align: center;
    }
    
    .share-platform-btn:hover {
      background: rgba(255, 204, 51, 0.2);
      border-color: var(--accent);
    }
    
    .info-text {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.5;
      margin-top: 12px;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      position: relative;
      width: 90vw;
      max-width: 700px;
      height: 70vh;
      max-height: 500px;
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(180deg, #071025 0%, #04101a 100%);
    }
    
    .modal-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .modal-card-inner {
      position: absolute;
      inset: 0;
      z-index: 2;
      display: flex;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 3;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .close-modal:hover {
      background: rgba(0, 0, 0, 0.8);
    }
    
    .status-message {
      display: none;
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(0, 0, 0, 0.8);
      color: var(--accent);
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255, 204, 51, 0.3);
      font-size: 0.9rem;
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
    }
    
    .status-message.active {
      display: block;
    }
    
    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .card-preview {
        max-width: 100%;
        height: 250px;
      }
    }
    
    @media (max-width: 768px) {
      header h1 {
        font-size: 1.5rem;
      }
      
      .template-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .actions {
        grid-template-columns: 1fr;
      }
      
      .share-platforms {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>🎆 Diwali Greeting Generator 🎆</h1>
      <p>Create personalized animated greetings and share with loved ones</p>
    </header>

    <div class="main-grid">
      <!-- LEFT PANEL: CONTROLS -->
      <div class="left-panel">
        <div class="panel">
          <div class="form-group">
            <label>Choose Template</label>
            <div class="template-buttons">
              <button class="template-btn active" onclick="selectTemplate('formal')">Formal</button>
              <button class="template-btn" onclick="selectTemplate('classic')">Classic</button>
              <button class="template-btn" onclick="selectTemplate('cute')">Cute</button>
              <button class="template-btn" onclick="selectTemplate('funny')">Funny</button>
            </div>
          </div>

          <div class="form-group">
            <label>Recipient Name *</label>
            <input type="text" id="recipientName" placeholder="e.g., Sharma Uncle" oninput="updatePreview()" />
          </div>

          <div class="form-group">
            <label>Recipient Title (Optional)</label>
            <input type="text" id="recipientTitle" placeholder="e.g., District Manager" oninput="updatePreview()" />
          </div>

          <div class="form-group">
            <label>Your Name *</label>
            <input type="text" id="senderName" placeholder="e.g., Raj Kumar" oninput="updatePreview()" />
          </div>

          <div class="form-group">
            <label>Message Tone</label>
            <select id="tone" onchange="updatePreview()">
              <option value="formal">Formal & Respectful</option>
              <option value="warm">Warm & Traditional</option>
              <option value="cute">Cute & Friendly</option>
              <option value="funny">Funny & Light</option>
            </select>
          </div>

          <div class="form-group">
            <label>Cultural Reference (Optional)</label>
            <select id="culture" onchange="updatePreview()">
              <option value="none">None</option>
              <option value="rama">Lord Rama's Return</option>
              <option value="light">Light Over Darkness</option>
              <option value="lakshmi">Lakshmi's Blessings</option>
            </select>
          </div>

          <div class="form-group">
            <label>Personal Message (Optional)</label>
            <textarea id="customMsg" placeholder="Add a personal touch..." oninput="updatePreview()"></textarea>
          </div>

          <div class="actions">
            <button class="btn btn-primary" onclick="openPreview()">👁️ Preview</button>
            <button class="btn btn-secondary" onclick="downloadGif(event)">⬇️ Download GIF</button>
          </div>

          <div class="actions">
            <button class="btn btn-secondary" style="grid-column: 1 / -1;" onclick="copyMessage()">📋 Copy Text</button>
            
          </div>

          <!-- SHARE SECTION -->
          <div id="shareSection" class="share-section">
            <div class="share-title">✨ Share Your Card ✨</div>
            
            <div class="share-link-box">
              <input type="text" id="shareLink" readonly placeholder="Your share link will appear here" />
              <button class="btn btn-primary" style="padding: 10px 14px; width: auto;" onclick="copyShareLink()">Copy</button>
            </div>

            <div class="share-platforms">
              <button class="share-platform-btn" onclick="sendAsGif()">🎁 Send as GIF</button>
              <button class="share-platform-btn" onclick="shareVia('whatsapp')">💬 WhatsApp</button>
              <button class="share-platform-btn" onclick="shareVia('telegram')">✈️ Telegram</button>
              <button class="share-platform-btn" onclick="shareVia('email')">📧 Email</button>
              <button class="share-platform-btn" onclick="shareVia('facebook')">👍 Facebook</button>
              <button class="share-platform-btn" onclick="shareVia('twitter')">𝕏 Twitter</button>
            </div>
            

            <div class="info-text">
              💡 Share this link with anyone! They'll see your card and can create their own greeting.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL: PREVIEW -->
      <div class="right-panel">
        <div class="card-preview" id="cardPreview">
          <canvas id="fireworksCanvas"></canvas>
          <div class="card-content">
            <div class="card-left">
              <div class="card-title" id="cardTitle">Happy Diwali</div>
              <div class="card-subtitle" id="cardSubtitle">Wishing you prosperity and joy</div>
            </div>
            <div class="card-right">
              <div class="card-recipient" id="cardRecipient">To: Friends & Family</div>
              <div class="card-message" id="cardMessage">May the festival of lights bring happiness to your home.</div>
              <div class="card-culture" id="cardCulture"></div>
              <div class="card-sender">— <span id="cardSender">Your Friend</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closePreview()">✕</button>
      <canvas id="modalCanvas"></canvas>
      <div class="modal-card-inner">
        <div style="width: 35%; background: #0b1020; padding: 16px; display: flex; flex-direction: column; justify-content: center; border-right: 2px solid rgba(255, 204, 51, 0.2);">
          <div class="card-title" id="modalTitle">Happy Diwali</div>
          <div class="card-subtitle" id="modalSubtitle">Wishing you prosperity and joy</div>
        </div>
        <div style="flex: 1; padding: 16px; display: flex; flex-direction: column; justify-content: center;">
          <div class="card-recipient" id="modalRecipient">To: Friends & Family</div>
          <div class="card-message" id="modalMessage">May the festival of lights bring happiness to your home.</div>
          <div class="card-culture" id="modalCulture"></div>
          <div class="card-sender">— <span id="modalSender">Your Friend</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- STATUS MESSAGE -->
  <div id="statusMsg" class="status-message"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

  <script>
    // TEMPLATES
    const templates = {
      formal: {
        title: "Shubh Deepavali",
        subtitle: "With warm regards",
        message: (name, title) => 
          `Respected ${name}${title ? ', ' + title : ''}\n\nOn this auspicious occasion of Diwali, I wish you and your family prosperity, good health, and endless happiness.`
      },
      classic: {
        title: "Happy Diwali",
        subtitle: "Celebrating light & joy",
        message: (name) => 
          `Dear ${name}\n\nMay the festival of lights fill your life with joy, prosperity, and wonderful moments with your loved ones.`
      },
      cute: {
        title: "Diwali Vibes! 🎉",
        subtitle: "Lights & Sweets",
        message: (name) => 
          `Hey ${name}!\n\nWishing you a Diwali full of colors, sweets, laughter, and beautiful memories!`
      },
      funny: {
        title: "Boom! 💥 (Virtual)",
        subtitle: "No smoke, just sparkle",
        message: (name) => 
          `Yo ${name}!\n\nHappy Diwali! May your sweets never finish and your pocket be full of happiness! 🎆`
      }
    };

    const cultureMessages = {
      none: "",
      rama: "This festival celebrates Lord Rama's victory over evil and his return to Ayodhya.",
      light: "Diwali symbolizes the triumph of light over darkness and good over evil.",
      lakshmi: "Lakshmi Puja invites blessings of prosperity and wealth into our homes."
    };

    const colors = {
      formal: ["#FFD700", "#FFFFFF", "#E6E6FA"],
      classic: ["#FF6F61", "#FFD166", "#6AB04A"],
      cute: ["#FFB6C1", "#FF69B4", "#FFD700"],
      funny: ["#FF3D00", "#00E5FF", "#FFEA00"]
    };

    // STATE
    let currentTemplate = "formal";
    let fireworksEngine = null;
    let modalFireworks = null;
    let currentGifUrl = null;

    // FIREEWORKS ENGINE
    function createFireworks(canvas, width = 500, height = 320) {
      const ctx = canvas.getContext("2d");
      canvas.width = width;
      canvas.height = height;

      let particles = [];
      let rockets = [];
      let running = false;
      let palette = colors.formal;

      function rand(a, b) {
        return a + Math.random() * (b - a);
      }

      function launch() {
        if (Math.random() < 0.15) {
          rockets.push({
            x: rand(50, width - 50),
            y: height,
            vx: rand(-2, 2),
            vy: rand(-15, -10),
            life: 0
          });
        }
      }

      function explode(x, y) {
        const count = Math.floor(rand(20, 50));
        const color = palette[Math.floor(Math.random() * palette.length)];
        for (let i = 0; i < count; i++) {
          const angle = (Math.PI * 2 * i) / count + rand(-0.3, 0.3);
          const speed = rand(2, 8);
          particles.push({
            x, y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: 0,
            maxLife: rand(50, 120),
            color,
            size: rand(1.5, 3)
          });
        }
      }

      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r},${g},${b},${alpha})`;
      }

      function step() {
        ctx.clearRect(0, 0, width, height);

        // Draw rockets
        for (let i = rockets.length - 1; i >= 0; i--) {
          const r = rockets[i];
          r.vy += 0.2;
          r.x += r.vx;
          r.y += r.vy;
          r.life++;

          ctx.fillStyle = "rgba(255,255,200,0.8)";
          ctx.beginPath();
          ctx.arc(r.x, r.y, 2, 0, Math.PI * 2);
          ctx.fill();

          if (r.vy > 0 || r.life > 100) {
            explode(r.x, r.y);
            rockets.splice(i, 1);
          }
        }

        // Draw particles
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.vy += 0.08;
          p.vx *= 0.98;
          p.x += p.vx;
          p.y += p.vy;
          p.life++;

          const progress = p.life / p.maxLife;
          const alpha = Math.max(1 - progress, 0) * 0.8;
          const size = p.size * (1 - progress * 0.7);

          ctx.fillStyle = hexToRgba(p.color, alpha);
          ctx.beginPath();
          ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
          ctx.fill();

          if (p.life >= p.maxLife) {
            particles.splice(i, 1);
          }
        }

        launch();
        if (running) requestAnimationFrame(step);
      }

      return {
        start() { if (!running) { running = true; step(); } },
        stop() { running = false; },
        setPalette(pal) { palette = pal; },
        clear() { ctx.clearRect(0, 0, width, height); }
      };
    }

    // UPDATE PREVIEW
    function updatePreview() {
      const template = templates[currentTemplate];
      const name = document.getElementById("recipientName").value || "Friend";
      const title = document.getElementById("recipientTitle").value;
      const sender = document.getElementById("senderName").value || "Your Friend";
      const custom = document.getElementById("customMsg").value;
      const culture = document.getElementById("culture").value;

      document.getElementById("cardTitle").textContent = template.title;
      document.getElementById("cardSubtitle").textContent = template.subtitle;
      document.getElementById("cardRecipient").textContent = `To: ${name}`;
      
      let msg = template.message(name, title);
      if (custom) msg += "\n\n" + custom;
      document.getElementById("cardMessage").textContent = msg;
      
      document.getElementById("cardCulture").textContent = cultureMessages[culture];
      document.getElementById("cardSender").textContent = sender;

      // Update modal too
      document.getElementById("modalTitle").textContent = template.title;
      document.getElementById("modalSubtitle").textContent = template.subtitle;
      document.getElementById("modalRecipient").textContent = `To: ${name}`;
      document.getElementById("modalMessage").textContent = msg;
      document.getElementById("modalCulture").textContent = cultureMessages[culture];
      document.getElementById("modalSender").textContent = sender;
    }

    function selectTemplate(t) {
      currentTemplate = t;
      document.querySelectorAll(".template-btn").forEach(btn => btn.classList.remove("active"));
      event.target.classList.add("active");
      
      if (fireworksEngine) fireworksEngine.setPalette(colors[t]);
      if (modalFireworks) modalFireworks.setPalette(colors[t]);
      updatePreview();
    }

    function openPreview() {
      document.getElementById("previewModal").classList.add("active");
      if (!modalFireworks) {
        modalFireworks = createFireworks(document.getElementById("modalCanvas"), 600, 400);
        modalFireworks.setPalette(colors[currentTemplate]);
      }
      modalFireworks.start();
    }

    function closePreview() {
      document.getElementById("previewModal").classList.remove("active");
      if (modalFireworks) modalFireworks.stop();
    }

    function copyMessage() {
      const template = templates[currentTemplate];
      const name = document.getElementById("recipientName").value || "Friend";
      const title = document.getElementById("recipientTitle").value;
      const sender = document.getElementById("senderName").value || "Your Friend";
      const custom = document.getElementById("customMsg").value;
      const culture = document.getElementById("culture").value;

      let msg = template.message(name, title);
      if (custom) msg += "\n\n" + custom;
      if (cultureMessages[culture]) msg += "\n\n" + cultureMessages[culture];
      msg += "\n\n— " + sender;

      navigator.clipboard.writeText(msg);
      showStatus("✓ Message copied to clipboard!");
    }
    // --- Cloudinary upload helper ---
async function uploadGifToCloudinary(blob) {
  const cloudName = "dvgzjzyqr";        // e.g. bharadwaj123
  const uploadPreset = "unsigned_diwali";  // e.g. unsigned_diwali

  try {
    const fd = new FormData();
    fd.append("file", blob, "diwali.gif");
    fd.append("upload_preset", uploadPreset);

    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
      method: "POST",
      body: fd
    });

    if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
    const data = await res.json();
    console.log("Cloudinary upload success:", data.secure_url);
    return data.secure_url; // public HTTPS URL
  } catch (err) {
    console.error("Cloudinary upload error:", err);
    return null;
  }
}

async function forceDownloadFromCloudinary(url, filename = "diwali.gif") {
  try {
    const res = await fetch(url);
    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = blobUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(blobUrl);
  } catch (err) {
    console.error("Download failed:", err);
  }
}


async function sendAsGif() {
  try {
    const gifUrl = currentGifUrl; // Your Cloudinary GIF URL (already uploaded)
    // Generate link to personalized greeting page (share.html or /api/share)
    const linkToCard = document.getElementById("shareLink").value; // Get from your share UI

    const text = 
      `🎆 I just created this animated Diwali greeting!\n` +
      `See my card & make your own here:\n${linkToCard}`;

    const response = await fetch(gifUrl);
    const blob = await response.blob();
    const file = new File([blob], "diwali.gif", { type: "image/gif" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        text: text,
        title: "Animated Diwali Greeting"
      });
    } else {
      alert("Your device does not support sharing files directly.");
    }
  } catch (err) {
    alert("Error preparing GIF for sharing: " + err.message);
  }
}

    async function downloadGif(e) {
  const btn = e.target;
  btn.disabled = true;
  btn.textContent = "⏳ Generating...";

  try {
    const gif = new GIF({ workers: 2, quality: 10, width: 500, height: 320 });
    const cardElement = document.getElementById("cardPreview");

    for (let i = 0; i < 10; i++) {
      const canvas = await html2canvas(cardElement, { useCORS: true, scale: 1 });
      gif.addFrame(canvas, { delay: 100 });
      await new Promise((r) => setTimeout(r, 100));
    }

    gif.on("finished", async (blob) => {
  showStatus("☁️ Uploading to Cloudinary...");
  const publicUrl = await uploadGifToCloudinary(blob);

  if (!publicUrl) {
    showStatus("❌ Upload failed");
    return;
  }

  await forceDownloadFromCloudinary(publicUrl); // <-- this line fixes it

  currentGifUrl = publicUrl;
  showShareSection(publicUrl);
  showStatus("✅ GIF uploaded & downloaded!");
});

    gif.render();
  } catch (err) {
    console.error(err);
    showStatus("❌ Error generating GIF");
    btn.disabled = false;
    btn.textContent = "⬇️ Download GIF";
  }
}

    function showShareSection(gifUrl, opts = {}) {
    const shareSection = document.getElementById("shareSection");
    const shareLinkInput = document.getElementById("shareLink");

    const name = document.getElementById("recipientName").value || "Friend";
    const sender = document.getElementById("senderName").value || "Your Friend";
    const template = templates[currentTemplate];
    const custom = document.getElementById("customMsg").value;
    const culture = document.getElementById("culture").value;

    let message = template.message(name, "");
    if (custom) message += "\n\n" + custom;
    if (cultureMessages[culture]) message += "\n\n" + cultureMessages[culture];

    // Build a share page link that contains the GIF url (prefer public http(s) URLs)
    const params = new URLSearchParams({
      title: template.title,
      message: message,
      sender: sender,
      gif: gifUrl, // IMPORTANT: must be public for external fetch
    });

    const baseUrl = window.location.href.split('?')[0];
   const shareUrl = `https://greet-diwali.vercel.app/api/share?title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}&sender=${encodeURIComponent(sender)}&gif=${encodeURIComponent(gifUrl)}`;
  //const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(`🎆 ${title} from ${sender}!\n\n✨ Create your own personalized Diwali card:\n${shareUrl}`)}`;
    shareLinkInput.value = shareUrl;
    shareSection.style.display = "block";
    shareSection.scrollIntoView({ behavior: "smooth" });

    // If the gifUrl is not http(s), show a small inline warning in shareSection
    if (opts.warning || !(gifUrl && /^https?:\/\//i.test(gifUrl))) {
      // add a visual hint if not already present
      let info = shareSection.querySelector('.info-text');
      if (!info) {
        info = document.createElement('div');
        info.className = 'info-text';
        shareSection.appendChild(info);
      }
      info.innerHTML = '⚠️ The GIF is currently local-only. If you want recipients to preview the GIF, host it on a public URL (server or cloud).';
    } else {
      const info = shareSection.querySelector('.info-text');
      if (info) info.innerHTML = '💡 Share link includes hosted GIF — recipients can preview it.';
    }
  }


   async function shareVia(platform) {
  const shareLink = document.getElementById("shareLink").value; // The personalized greeting URL
  const template = templates[currentTemplate];
  const sender = document.getElementById("senderName").value || "A Friend";

  // Compose message with greeting card link and CTA for creating own card
  const message = `🎆 ${template.title} from ${sender}!\n\n` +
                  `View animated greeting card here: ${shareLink}\n\n` +
                  `Want to create your own? Visit: https://greet-diwali.vercel.app/index.html`;

  // Fallback platform sharing URLs
  let url = "";
  switch (platform) {
    case "whatsapp":
      url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      break;
    case "telegram":
      url = `https://t.me/share/url?url=${encodeURIComponent(shareLink)}&text=${encodeURIComponent(message)}`;
      break;
    case "email":
      url = `mailto:?subject=${encodeURIComponent(template.title)}&body=${encodeURIComponent(message)}`;
      break;
    case "facebook":
      // Facebook sharing only accepts URLs, so share the personalized greeting card link directly
      url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareLink)}`;
      break;
    case "twitter":
      url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
      break;
  }

  if (url) {
    window.open(url, "_blank");
  }
}

    function copyShareLink() {
      const link = document.getElementById("shareLink").value;
      if (!link) {
        showStatus("❌ Generate a GIF first!");
        return;
      }
      navigator.clipboard.writeText(link);
      showStatus("✓ Link copied to clipboard!");
    }

    function showStatus(msg) {
      const el = document.getElementById("statusMsg");
      el.textContent = msg;
      el.classList.add("active");
      setTimeout(() => el.classList.remove("active"), 3000);
    }

    // LOAD SHARED CARD
    function loadSharedCard() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("shared") !== "1") return;

      const title = params.get("title");
      const message = params.get("message");
      const sender = params.get("sender");
      const template = params.get("template");

      if (template) {
        currentTemplate = template;
        document.querySelectorAll(".template-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.template-btn:nth-child(${{formal:1,classic:2,cute:3,funny:4}[template] || 1})`).classList.add("active");
      }

      if (title) {
        document.getElementById("recipientName").value = sender || "Friend";
        document.getElementById("senderName").value = sender || "Friend";
      }

      if (fireworksEngine) fireworksEngine.setPalette(colors[currentTemplate]);
    }

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
      fireworksEngine = createFireworks(document.getElementById("fireworksCanvas"));
      fireworksEngine.setPalette(colors.formal);
      fireworksEngine.start();

      updatePreview();
      loadSharedCard();

      document.getElementById("recipientName").addEventListener("input", updatePreview);
      document.getElementById("recipientTitle").addEventListener("input", updatePreview);
      document.getElementById("senderName").addEventListener("input", updatePreview);
      document.getElementById("customMsg").addEventListener("input", updatePreview);
      document.getElementById("culture").addEventListener("change", updatePreview);
      document.getElementById("tone").addEventListener("change", updatePreview);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closePreview();
    });
    function showShareSection(gifUrl) {
  const shareSection = document.getElementById("shareSection");
  const shareLinkInput = document.getElementById("shareLink");

  const name = document.getElementById("recipientName").value || "Friend";
  const sender = document.getElementById("senderName").value || "Your Friend";
  const template = templates[currentTemplate];
  const custom = document.getElementById("customMsg").value;
  const culture = document.getElementById("culture").value;

  let message = template.message(name, "");
  if (custom) message += "\n\n" + custom;
  if (cultureMessages[culture]) message += "\n\n" + cultureMessages[culture];

  // Create link for share.html
  const params = new URLSearchParams({
    title: template.title,
    message: message,
    sender: sender,
    gif: gifUrl,
  });

  const baseUrl = window.location.href.split('?')[0];
  const apiShareBase = "https://greet-diwali.vercel.app/api/share";
const shareUrl = `${apiShareBase}?${params.toString()}`;
  shareLinkInput.value = shareUrl;
  shareSection.style.display = "block";
}
  </script>
</body>
</html>