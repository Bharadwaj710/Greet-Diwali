<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title id="pageTitle">Diwali Greeting ðŸŽ† - Personalized Card</title>
<meta name="description" content="Check out this beautiful Diwali greeting card!" />
<meta property="og:title" content="Happy Diwali ðŸŽ†" />
<meta property="og:description" content="A beautiful personalized Diwali greeting just for you!" />
<meta property="og:type" content="website" />
<meta property="og:image" content="" id="ogImage" />
<meta property="og:image:type" content="image/gif" />
<meta property="og:image:width" content="600" />
<meta property="og:image:height" content="400" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="Happy Diwali ðŸŽ†" />
<meta property="twitter:description" content="A beautiful personalized Diwali greeting just for you!" />
<meta property="twitter:image" content="" id="twitterImage" />
<style>
  :root { --primary: #ffcc33; --primary-dark: #ff6f61; --bg: #0b1020; --bg-light: #071025; }
  body, html {
    width: 100%; height: 100%;
    font-family: 'Inter', system-ui, sans-serif;
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg-light) 100%);
    color: #fff; overflow-x: hidden;
  }
  .app-view {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: 56px; margin-top: 32px;
  }
  .main-greeting { min-width: 400px; }
  .card-box {
    width: 240px;
    min-height: 370px;
    background: rgba(255,255,255,0.08);
    border: 2px dashed #ffd70044;
    border-radius: 18px;
    box-shadow: 0 0 18px #ffd70022, 0 0 4px #1112;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    padding: 20px 0;
    margin-top: 20px;
    transition: box-shadow 0.23s;
  }
  .card-box-title {
    color: #ffd700;
    font-weight: 500; font-size: 1.1rem;
    margin-bottom: 24px;
    letter-spacing: 2px;
    text-align: center;
  }
  header { text-align: center; margin-bottom: 38px; }
  .emoji-bounce { font-size: 3.1rem; margin-bottom: 14px; }
  header h1 {
    font-size: 2.6rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 11px; font-weight: 800;
  }
  header p { font-size: 1.15rem; }
  .gif-container {
    max-width: 600px; border-radius: 12px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(255,204,51,0.2);
    margin: 22px auto 0 auto;
  }
  .fullscreen-gif-container {
  margin-bottom: 22px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 15px 40px rgba(255,204,51,0.19);
}
.fullscreen-gif-container img {
  width: 100%;
  display: block;
  border-radius: 12px;
}
  .gif-container img { width: 100%; display: block; border-radius: 12px; }
  .card-details { text-align: center; margin-top: 11px;}
  .card-title { color: #ffcc33; font-size: 2rem; font-weight: 800;}
  .card-message { font-size: 1.05rem; margin: 20px 0; white-space: pre-wrap;}
  .card-sender { font-size: 1rem; opacity: 0.75; border-top: 1px solid rgba(255,204,51,0.2); padding-top: 20px; margin-top: 20px;}
  /* Card placement styles */
  .legendary-card {
  position: relative;
  min-width: 240px;
  min-height: 266px;
  margin: 0 auto 9px auto;
  border-radius: 15px;
  box-shadow: 0 4px 18px 5px #EAC43555, 0 0 2px #FFF;
  display: flex;
  color: #fff;
  flex-direction: column;
  align-items: center;
  font-family: 'VT323', monospace;
  overflow: hidden;
  cursor: pointer;
  z-index: 2;
  background: linear-gradient(135deg, gold, gold 60%, #ffe3d9, #fff6d9, #ffc3b8 95%);
  transform-style: preserve-3d;
  animation: cardSlideIn 0.5s ease forwards, floatIdle 5s ease-in-out infinite, cardGlow 3s ease-in-out infinite,glowIn 0.4s ease-out;
  transition: box-shadow 0.2s ease, filter 0.13s ease;
  will-change: transform, box-shadow;
}
.card-purple {
  box-shadow: 0 0 30px 6px rgba(138, 43, 226, 0.6), 0 0 60px 12px rgba(138, 43, 226, 0.3);
  border: 2px solid rgba(138, 43, 226, 0.8);
}
  .card-purple {
    background: linear-gradient(135deg, #772ebd, #9600d8, #bf69cc 75%, #320a46 100%);
  }
  .legendary-card .card-rarity {
    position: absolute; left: 14px; top: 15px;
    color: #fff; font-size: 1em;
    letter-spacing: 1.4px; text-shadow: 0 0 7px #ffd700, 1px 1px 2px #000;
    z-index: 3;
  }
  .card-purple .card-rarity {
    color: #e0ceff; text-shadow: 0 0 8px #d900ff, 1px 1px 3px #22003b;
  }
  .legendary-card .pixel-img {
    width: 111px; height:112px;
    margin: 28px auto 14px auto;
    image-rendering: pixelated;
    border-radius: 8px;
    box-shadow: 0 0 16px #ffd70044;
  }
  .card-name {
    font-size: 1.1rem; font-weight: bold; color: #fff; margin: 3px 0 10px 0;
    letter-spacing: 1.5px; text-shadow: 0 0 10px #222;
    z-index: 1;
  }
  .card-purple .card-name { color: #e6c4ff;}
  .card-desc {
    font-size: 0.97rem;
    color: #eee; text-align: center;
    margin: 8px 17px 0 17px; z-index: 1; text-shadow: 0 0 4px #111;
  }
  .legendary-card button, .modal-card-popup button {
    margin: 19px auto 0 auto;
    padding: 7px 20px;
    font-size: 1.07em;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    background: linear-gradient(120deg, #fffbbb, #ffd036 55%, #ffadfa 100%);
    color: #563705;
    cursor: pointer;
    box-shadow: 0 2px 8px #fff8, 0 0 2px #fff3;
    transition: background .18s;
  }
  .card-fadeout { animation: cardFadeOut 0.46s forwards;}
  /* Ensure popup legendary-card has the same look as vault card */
.modal-card-popup.legendary-card {
  height: 346px;
  box-shadow: 0 4px 18px 5px #EAC43577, 0 0 2px #FFF, 0 0 32px #ffd70099;
  border-radius: 15px;
  opacity: 1 !important;
}
  @keyframes cardFadeOut { to { opacity:0; transform: translateX(60px) scale(.85);}
  }
  @keyframes cardGlow {
  0%, 100% { box-shadow: 0 0 18px 5px rgba(255, 215, 0, 0.4), 0 0 4px #fff2; }
  50% { box-shadow: 0 0 28px 8px rgba(255, 215, 0, 0.75), 0 0 6px #fff8; }
}
@keyframes floatIdle {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-6px) scale(1.01); }
}
@keyframes glowIn {
  from {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
    transform: scale(0.95);
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
@keyframes cardSlideIn {
  from { opacity:0; transform: translateY(30px) scale(0.96);}
  to { opacity:1; transform: translateY(0) scale(1);}
}  /* Modal styles (popup/download) */
  .modal-bg { position:fixed; inset:0; background:rgba(20,8,50,.96); z-index:999;
    display:none; align-items:center; justify-content:center;}
  .modal-bg.active { display:flex;}
    @keyframes modalPop { from {opacity: 0; transform: scale(0.6);} to{opacity:1; transform:scale(1);}}
  .modal-close-btn { position: absolute; top: 14px; right: 16px; background: rgba(25,12,23,0.88); color: #ffd700;
    font-size:2em; border:none; border-radius:100%; width:38px;height:38px;
    cursor:pointer; display:flex;align-items:center;justify-content:center; transition:background .2s;}
  .modal-close-btn:hover { background:#ffd700; color:#320a46; box-shadow:0 0 14px #ffd;}
  /* Notification Styles */
  .notify-bg { position: fixed; inset: 0; z-index:99999; background: rgba(32,12,48,0.8); display: flex;
    align-items: center; justify-content: center;}
  .notify-popup {
    background: linear-gradient(90deg, #ffd700 60%, #ffe3d9 100%);
    color: #4e3806; font-weight: 700; font-size: 1.16em;
    border-radius: 14px; padding: 30px 36px; min-width:220px; min-height:80px;
    box-shadow: 0 9px 42px #ffd966b0, 0 0 8px #fff8;
    display: flex; flex-direction:column; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .notify-popup button {
    margin-top:18px; background:#fffdd9; border-radius:8px; color:#b88a00; font-weight:700;
    font-size:1em; border:none; padding:8px 28px; cursor:pointer; box-shadow:0 2px 8px #ffd8;
  }
  .card-loader-spin { width:48px;height:48px; border-radius:50%;
    border:7px solid #ffd700; border-top:7px solid #f7b40a; animation:spinLoader 1.05s linear infinite;
    margin:18px auto; box-shadow:0 2px 12px #ffd7008e;}
    
  @keyframes spinLoader { to { transform: rotate(360deg);}}
  /* -------------------------------
   Responsive Design Enhancements
--------------------------------*/
/* -------------------------------------------
   Enhanced Responsive Fix (Cards not cutoff)
--------------------------------------------*/

@media (max-width: 1200px) {
  .app-view {
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 40px;
  }

  .main-greeting {
    width: 80%;
    min-width: unset;
  }

  .card-box {
    width: 300px;
    padding: 18px;
  }

  .legendary-card {
    transform: scale(0.95);
    width: 190px;
    height: 275px;
  }

  .modal-card-popup {
    width: 220px;
    height: 300px;
  }
}

@media (max-width: 1000px) {
  .app-view {
    flex-direction: column;
    align-items: center;
    gap: 32px;
    margin-top: 20px;
  }

  .main-greeting {
    width: 90%;
    text-align: center;
  }

  .gif-container {
    max-width: 90%;
  }

  .card-box {
    width: 90%;
    min-height: auto;
    padding: 16px;
  }

  .legendary-card {
    width: 180px;
    height: 260px;
    transform: scale(1);
  }

  .modal-card-popup {
    width: 210px;
    height: 290px;
  }
}

@media (max-width: 768px) {
  header h1 {
    font-size: 2rem;
  }

  .card-box {
    width: 88%;
  }

  .legendary-card {
    width: 165px;
    height: 240px;
  }

  .modal-card-popup {
    width: 200px;
    height: 275px;
  }
}

@media (min-width: 480px) {
  .app-view {
    flex-direction: column;
    gap: 20px;
    margin-top: 12px;
  }

  .main-greeting {
    width: 95%;
  }

  .gif-container {
    width: 95%;
  }

  .card-box {
    width: 92%;
    padding: 12px;
  }

  .legendary-card {
    width: 150px;
    height: 225px;
    transform: scale(0.95);
  }

  .modal-card-popup {
    width: 190px;
    height: 260px;
  }

  .notify-popup {
    width: 85%;
    padding: 20px;
  }
}
/* By default, stack in column: message on top of card */
.unlock-flex-row {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}

/* On small screens, use row: message left, card right */
@media (max-width: 600px) {
  .unlock-flex-row {
    flex-direction: row;
    align-items: flex-start;
    justify-content: center;
    gap: 9px;
  }
  .unlock-msg {
    margin: 0 10px 0 0 !important;
    font-size: 1rem !important;
    min-width: 93px;
    text-align: right;
    display: flex;
    align-items: center;
  }
}
@media (min-width: 601px) {
  .unlock-msg {
    margin: 18px 0 14px 0 !important;
    text-align: center;
    font-size: 18px !important;
  }
}

/* Fullscreen Modal for Card */
.modal-bg#greetingModal {
  display: none; position: fixed; inset: 0;
  background: rgba(24,14,40,0.95); z-index: 9999;
  align-items: center; justify-content: center;
}
.modal-bg#greetingModal.active { display: flex; }
.fullscreen-card-popup {
  position: relative; max-width: 430px; width:96vw; min-height: 370px;
  background: linear-gradient(120deg,#18173a 75%, #ffe69d 135%);
  border-radius: 22px; box-shadow: 0 18px 80px #ffd7009a, 0 0 6px #fff9;
  padding: 48px 34px 40px 34px; text-align: left;
}
.close-btn {
  position: absolute; top: 11px; right: 15px; font-size: 2rem; color: #ffd700;
  background: rgba(0,0,0,0.66); border: none; border-radius: 50%; width:38px; height:38px; cursor: pointer; z-index:11;
}
.create-yours-btn {
  top: 15px; right: 67px; background: linear-gradient(120deg,#fffcab,#ffd036 55%,#ffadfa 100%);
  color: #320a46; font-size:1rem; font-weight:700; border-radius:8px; border:none; cursor:pointer; z-index:10;
  padding:8px 24px; box-shadow: 0 0 14px #ffd966b8;
}
#fullscreenCardDetails {
  margin-top: 36px;
}

/* Large, readable styles for fullscreen card */
#fullscreenCardDetails .card-title { font-size:2.2rem; color:#ffcc33; font-weight:800; margin-bottom:15px;}
#fullscreenCardDetails .card-message { font-size:1.17rem; line-height:1.8; color:#fff; margin-bottom:28px;white-space:pre-wrap;}
#fullscreenCardDetails .card-sender { font-size:1.1rem; color:#ffd700aa; border-top: 1px solid #ffd70055; margin-top:14px; padding-top:18px;}
</style>
</head>
<body>
<div class="app-view">
  <div id="greetingModal" class="modal-bg" tabindex="-1">
  <div class="fullscreen-card-popup">
    <button class="close-btn" onclick="closeGreetingModal()">Ã—</button>
    <div class="fullscreen-gif-container" id="fullscreenGifContainer"></div>
    <div id="fullscreenCardDetails"></div>
  </div>
</div>
  <div class="main-greeting">
    <header>
      <div class="emoji-bounce">ðŸŽ† âœ¨ ðŸŽ‡</div>
      <h1>Happy Diwali!</h1>
      <p id="greeting">A beautiful greeting from a friend</p>
      <button 
  class="create-yours-btn"
  style="align-self: flex-start; margin-top: 80px;" 
  onclick="window.open('https://greet-diwali.vercel.app/','_blank','noopener,noreferrer')"
>
  Create Yours
</button>

    </header>
    <div class="gif-container" id="gifContainer"></div>
    <div class="card-details" id="cardDetails"></div>
  </div>
  <div class="card-box" id="cardBox">
    <div class="card-box-title">Your Card Vault</div>
    <!-- Legendary card will be placed here -->
  </div>
</div>
<div class="notify-bg" id="notifyBg">
  <div class="notify-popup" tabindex="0">
    ðŸŽ‰ You unlocked a special character!
    <button class="notify-popup-btn" onclick="startCardUnlock()">Show my card</button>
  </div>
</div>
<div class="modal-bg" id="modalBg" tabindex="-1"></div>
<script>
const legendaryCards = [
  { name: "Lord Rama", rarity: "Legendary", color: "gold", img: "/assets/pixels/rama.png", desc: "Seventh avatar of Vishnu. The hero of the Ramayana, embodies virtue and dharma." },
  { name: "Sita", rarity: "Legendary", color: "gold", img: "/assets/pixels/sita.png", desc: "Consort of Lord Rama, a legend of purity, nobility, and devotion." },
  { name: "Ravan", rarity: "Legendary", color: "gold", img: "/assets/pixels/ravan.png", desc: "King of Lanka, famed antagonist of Ramayana, symbol of mastery but also ego." },
  { name: "Hanuman", rarity: "Epic", color: "purple", img: "/assets/pixels/hanuman.png", desc: "Devout follower of Rama, famed for immense strength, courage, and loyalty." },
  { name: "Lakshmana", rarity: "Epic", color: "purple", img: "/assets/pixels/lakshmana.png", desc: "Devoted brother to Rama, known for selfless service and valor." }
];

function getParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    title: params.get("title") || "Happy Diwali ðŸŽ†",
    message: params.get("message") || "Wishing you a bright and joyous Diwali!",
    sender: params.get("sender") || "A Friend",
    gif: params.get("gif") || null
  };
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function loadCard() {
  const params = getParams();

  document.getElementById("pageTitle").textContent = `${params.title} ðŸŽ†`;
  document.querySelector('meta[property="og:title"]').setAttribute("content", params.title);
  document.querySelector('meta[property="og:description"]').setAttribute("content", params.message);
  document.querySelector('#ogImage').setAttribute("content", params.gif);
  document.querySelector('#twitterImage').setAttribute("content", params.gif);
  
  document.getElementById("greeting").textContent = `A beautiful greeting from ${params.sender}`;
  
  document.getElementById("gifContainer").innerHTML = params.gif
    ? `<img src="${params.gif}" alt="Diwali Greeting GIF" style="border-radius:12px; width:100%;">`
    : "";

  const cardDetails = document.getElementById("cardDetails");
  cardDetails.innerHTML = `
    <div class="card-title">${escapeHtml(params.title)}</div>
    <div class="card-message">${escapeHtml(params.message)}</div>
    <div class="card-sender">â€” ${escapeHtml(params.sender)}</div>
  `;  
  // Attach click handler here to support share scenarios
  if (cardDetails) {
    cardDetails.style.cursor = "pointer";
    cardDetails.setAttribute("title", "View fullscreen");
    // Remove previous, if present
    cardDetails.onclick = null;
    cardDetails.onclick = openGreetingModal;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadCard();
  setTimeout(() => {
    const notify = document.getElementById('notifyBg');
    if (notify) {
      notify.style.display = 'flex';
      const popup = notify.querySelector('.notify-popup');
      if (popup) popup.focus();
    }
  }, 800);

document.addEventListener("DOMContentLoaded", () => {
  loadCard();

  document.getElementById('greetingModal').addEventListener('click', function(e){
    if(e.target === this) closeGreetingModal();
  });

  document.addEventListener('keydown',function(e){
    if(document.getElementById('greetingModal').classList.contains('active') && e.key==='Escape'){
      closeGreetingModal();
    }
  });
});
  // Make greeting card clickable for fullscreen popup
  const details = document.getElementById('cardDetails');
  details.style.cursor = "pointer";
  details.setAttribute("title", "View fullscreen");
  details.addEventListener("click", openGreetingModal);

  const modal = document.getElementById('greetingModal');
  modal.addEventListener('click', function(e){
    if(e.target === modal) closeGreetingModal();
  });
});

function openGreetingModal() {
  // Get params to access GIF
  const params = getParams();
  // Set content
  document.getElementById('fullscreenCardDetails').innerHTML =
    document.getElementById('cardDetails').innerHTML;
  // Add GIF (if exists)
  document.getElementById('fullscreenGifContainer').innerHTML =
    params.gif
      ? `<img src="${params.gif}" alt="Diwali Greeting GIF" style="border-radius:12px; width:100%;">`
      : "";
  // Show modal
  document.getElementById('greetingModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}
function closeGreetingModal() {
  document.getElementById('greetingModal').classList.remove('active');
  document.body.style.overflow = '';
}

document.addEventListener('keydown',function(e){
  if(document.getElementById('greetingModal').classList.contains('active') && e.key==='Escape'){
    closeGreetingModal();
  }
});

/* ---------------------------
   Card tilt / hover behavior
   --------------------------- */
function enableCardTilt(cardElem) {
  // ensure preserve-3d and smooth transitions
  cardElem.style.transformStyle = 'preserve-3d';
  cardElem.style.transition = 'transform 300ms ease';

  let rafId = null;
  let currentX = 0, currentY = 0, targetX = 0, targetY = 0;

  function render() {
    // simple lerp for smoothness
    currentX += (targetX - currentX) * 0.15;
    currentY += (targetY - currentY) * 0.15;
    cardElem.style.transform = `rotateX(${currentX}deg) rotateY(${currentY}deg) scale(1.03)`;
    rafId = requestAnimationFrame(render);
  }

  cardElem.addEventListener('mousemove', (e) => {
    const rect = cardElem.getBoundingClientRect();
    const x = (e.clientX - rect.left) - rect.width / 2;
    const y = (e.clientY - rect.top) - rect.height / 2;
    // tilt: small angle, invert X for natural feel
    targetY = (x / rect.width) * 10;   // rotateY
    targetX = -(y / rect.height) * 10; // rotateX
    if (!rafId) render();
  });

  cardElem.addEventListener('mouseleave', () => {
    // smooth return to center
    targetX = 0;
    targetY = 0;
    // let render settle then cancel RAF
    setTimeout(() => {
      if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
      cardElem.style.transition = 'transform 380ms cubic-bezier(.2,.9,.2,1)';
      cardElem.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)';
      setTimeout(() => { cardElem.style.transition = ''; }, 420);
    }, 300);
  });
}

/* ---------------------------
   Unlock + show card in vault
   --------------------------- */
let unlockedCard = null;

function startCardUnlock() {
  const notifyBg = document.getElementById('notifyBg');
  notifyBg.innerHTML = `
    <div class="notify-popup">
      <div class="card-loader-spin"></div>
      <div style="font-size:1.15em;margin-top:16px;">Unlocking your character...</div>
    </div>
  `;
  setTimeout(() => {
    unlockedCard = legendaryCards[Math.floor(Math.random() * legendaryCards.length)];
    notifyBg.style.display = "none";
    showLegendaryCard(unlockedCard);
  }, 1200);
}

function showLegendaryCard(cardobj) {
  const cardBox = document.getElementById('cardBox');
  // Only append if not already present
  if (!cardBox.querySelector('.legendary-card')) {
    const cardDiv = document.createElement('div');
    cardDiv.className = `legendary-card card-${cardobj.color}`;
    cardDiv.innerHTML = `
      <div class="card-rarity">${cardobj.rarity}</div>
      <img class="pixel-img" src="${cardobj.img}" />
      <div class="card-name">${cardobj.name}</div>
      <div class="card-desc">${cardobj.desc}</div>
      <button onclick="event.stopPropagation(); downloadCard()">Download Card</button>
    `;
    cardBox.appendChild(cardDiv);

    // enable tilt + idle floating (tilt function handles hover)
    enableCardTilt(cardDiv);

    // When clicked, pass the data object to open popup
    cardDiv.addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') {
        popupCardManual(cardobj, cardDiv);
      }
    });
  }
}

/* ---------------------------
   Popup (modal) behavior
   --------------------------- */
function popupCardManual(cardobj, sourceCardElem = null) {
  const modal = document.getElementById('modalBg');
  modal.innerHTML = ''; // clear previous

  // Message above the card
  const msgDiv = document.createElement('div');
  msgDiv.className = 'unlock-msg';
  msgDiv.textContent = `You have unlocked an ${cardobj.rarity} character!!`;
  msgDiv.style.fontFamily = "inherit";
  msgDiv.style.color = cardobj.color === "gold" ? "#ffd700" : "#b780ff";
  msgDiv.style.textAlign = "center";
  msgDiv.style.fontSize = "18px";
  msgDiv.style.fontWeight = "bold";
  msgDiv.style.margin = "18px 0 14px 0";
  msgDiv.style.letterSpacing = "1px";

  // Build popup card identical to main card (inherit full styles)
  const popupCard = document.createElement('div');
  popupCard.className = `legendary-card modal-card-popup card-${cardobj.color}`;
  popupCard.innerHTML = `
    <div class="card-rarity">${cardobj.rarity}</div>
    <img class="pixel-img" src="${cardobj.img}" />
    <div class="card-name">${cardobj.name}</div>
    <div class="card-desc">${cardobj.desc}</div>
    <button onclick="event.stopPropagation(); downloadCard()">Download Card</button>
  `;
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.className = 'modal-close-btn';
  closeBtn.innerHTML = 'Ã—';
  closeBtn.onclick = () => closeCardPopup(popupCard);

  modal.appendChild(msgDiv);
  modal.appendChild(popupCard);
  modal.appendChild(closeBtn);
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';

  // Tilt on modal too
  enableCardTilt(popupCard);

  // Backdrop click should close
  modal.addEventListener('click', function onBackdrop(e) {
    if (e.target === modal) {
      modal.removeEventListener('click', onBackdrop);
      closeCardPopup(popupCard);
    }
  });
const flexWrap = document.createElement('div');
flexWrap.className = 'unlock-flex-row';
flexWrap.appendChild(msgDiv);
flexWrap.appendChild(popupCard);

modal.appendChild(flexWrap);
modal.appendChild(closeBtn);
  // Esc to close
  function onKey(e) {
    if (e.key === 'Escape') {
      closeCardPopup(popupCard);
      document.removeEventListener('keydown', onKey);
    }
  }
  document.addEventListener('keydown', onKey);
}

function closeCardPopup(cardDiv) {
  const modal = document.getElementById('modalBg');
  if (!cardDiv) {
    modal.classList.remove('active');
    modal.innerHTML = '';
    document.body.style.overflow = '';
    return;
  }
  cardDiv.classList.add('card-fadeout');
  setTimeout(() => {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    modal.innerHTML = '';
  }, 445);
}

/* ---------------------------
   Download (html2canvas)
   --------------------------- */
function downloadCard() {
  const target = document.querySelector('.modal-card-popup');
  if (!target) return;
  html2canvas(target, {backgroundColor: null}).then(canvas => {
    const link = document.createElement('a');
    link.download = "legendary_card.png";
    link.href = canvas.toDataURL();
    link.click();
  }).catch(err => {
    console.error('downloadCard error', err);
  });
}

/* Expose startCardUnlock for inline onclick */
window.startCardUnlock = startCardUnlock;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
